<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content=light name=color-scheme><link href=https://nttis.github.io/blog/preflight.css rel=stylesheet><style>*{font-family:serif}:root{background-color:#e6e6e6;font-size:20px}h1{font-size:1.75rem}h2{font-size:1.5rem}h3{font-size:1.25rem}h4{font-size:1cap}h5{font-size:.75rem}h6{font-size:.6rem}h1,h2,h3,h4,h5,h6{font-weight:700}</style><style>.note{background-color:#0f03;padding:.5rem}.note p{margin-bottom:.5rem}</style><title>Rust, Nix, Zig and cross-compilation</title><link href=https://nttis.github.io/blog/syntax.css rel=stylesheet><style>*{line-height:1.8rem}article{max-width:768px;margin:auto;padding:.5rem}article,main{flex-direction:column;gap:1.25rem;display:flex}article header{margin-bottom:3rem}ul{margin-left:1.5rem}blockquote{border:thin dotted #000;border-radius:.2rem;margin-left:1.5rem;margin-right:1.5rem;padding:.5rem}code *{font-family:monospace}p code,li code{background-color:#ccc;border:thin dotted #000;border-radius:.2rem;padding:.2rem;font-family:monospace}a{color:#06e;text-decoration:underline}ul,menu{list-style:outside}ol{list-style:decimal}.footnotes{margin-left:1rem}</style><style>pre{padding:.5rem;overflow:auto}pre[data-linenos]{padding:.5rem}pre table td{padding:0}pre table td:first-of-type{text-align:center;vertical-align:top;user-select:none}pre mark{background-color:#fefce8e6;display:block}pre table{border-collapse:collapse;width:100%}</style><body><article><header><p style=margin-bottom:0>March 26, 2025<h1 style=margin-top:0>Rust, Nix, Zig and cross-compilation</h1></header><main><p>Let's say I have some Rust code:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Hello, world!<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>And I want to cross-compile this code using <a href=https://nixos.org>Nix</a>. No Docker, no Podman, no <a href=https://github.com/cross-rs/cross>cross</a>. Just raw, vanilla cross-compilation. How hard could it possibly be?<p>The rules are:<ul><li>The program must be able to run on all the major operating systems. (Linux, Windows, MacOS, Android through Termux).<li>It must be statically linked<sup class=footnote-reference id=fr-1-1><a href=#fn-1>1</a></sup>.<li>It must run on the 2 major architectures for each operating system. (ie. x86_64 and aarch64)</ul><p>Let's take a look at <a href=https://doc.rust-lang.org/rustc/platform-support.html>Rust's platform support table</a>. The Tier 1 targets are:<ul><li>aarch64-apple-darwin<li>aarch64-unknown-linux-gnu<li>x86_64-apple-darwin<li>x86_64-pc-windows-msvc<li>x86_64-unknown-linux-gnu</ul><p>The Tier 2 targets are:<ul><li>aarch64-pc-windows-msvc<li>aarch64-linux-android (without host tools)<li>x86_64-linux-android (without host tools)</ul><p>At first glance, this level of support is quite great! All the targets we care about are either Tier 1 or Tier 2. In theory, this should work seamlessly with just a <code>cargo build</code>.<p>But let's look a bit closer. One of our rules is <code>It must be statically linked</code>. Except for where we absolutely must (MacOS and Android), we avoid linking against any system dependencies, including the libc.<p>And thus we have to exclude all the <code>-gnu</code> targets since <code>glibc</code> does not support static linking. Instead, we look at <a href=https://musl.libc.org>musl libc</a>. These are in Tier 2:<ul><li>x86_64-unknown-linux-musl<li>aarch64-unknown-linux-musl</ul><p>All hope is not yet lost. But let's look closer (again), at Windows this time.<p>You may have noticed that the Windows targets are using the MSVC ABI. This requires the MSVC headers and toolchain. Visual Studio installations ship with this toolchain, but we are cross-compiling from Linux, so...<p>While the MSVC toolchain is standalone and not glued to Visual Studio, it's <em>non-free</em>. You are forbidden from redistributing it. It's <em>probably</em> fine to have a script that downloads the required dependencies straight from Microsoft, and if you are intending to publish this project, contributors can use the same script to download dependencies themselves. Technically you aren't redistributing anything, just a <em>way</em> to download the MSVC toolchain. Projects like <a href=https://github.com/mstorsjo/msvc-wine>msvc-wine</a> and <a href=https://github.com/rust-cross/cargo-xwin>cargo-xwin</a> exist.<p>However, IANAL, and I would rather not mess with anything legal. If I can help it, I want to avoid the MSVC ABI. In this case, our other choices are:<ul><li>x86_64-pc-windows-gnu (Tier 1!)<li>aarch64-pc-windows-gnullvm (Tier 2, without host tools)</ul><p>Right, let's get started.<h2 id=nix-setup><a aria-label="Anchor link for: nix-setup" class=zola-anchor href=#nix-setup>Nix setup</a></h2><p>I am using <a href=https://github.com/oxalica/rust-overlay>rust-overlay</a> and <a href=https://github.com/nix-community/naersk>naersk</a> to manage the Rust toolchain and to facilitate cross-compilation, respectively.<p>First, we need a Rust toolchain. This can easily be done with <code>rustup</code>. In Nix, we use <code>rust-overlay</code> instead.<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-comment z-line z-number-sign z-nix"># This is a flake. Most of it was snipped for brevity.</span>
</span><tr><td>2<td><span class="z-source z-nix"><span class="z-variable z-parameter z-function z-4 z-nix">inputs</span><span class="z-punctuation z-definition z-function z-nix">:</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>3<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">pkgs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-support z-function z-nix">import</span> <span class="z-variable z-parameter z-name z-nix">inputs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">nixpkgs</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>4<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">system</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-linux<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span> <span class="z-comment z-line z-number-sign z-nix"># We are building on x86_64 Linux</span>
</span><tr><td>5<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">overlays</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span><span class="z-variable z-parameter z-name z-nix">inputs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">rust-overlay</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">overlays</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">default</span><span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>6<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>7<td><span class="z-source z-nix">
</span><tr><td>8<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">toolchain</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">rust-bin</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">stable</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">latest</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">minimal</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">override</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>9<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">targets</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>10<td><span class="z-source z-nix">      <span class="z-comment z-line z-number-sign z-nix"># Our Linux targets</span>
</span><tr><td>11<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-unknown-linux-musl<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>12<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-unknown-linux-musl<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>13<td><span class="z-source z-nix">
</span><tr><td>14<td><span class="z-source z-nix">      <span class="z-comment z-line z-number-sign z-nix"># Our Windows targets</span>
</span><tr><td>15<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-pc-windows-gnu<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>16<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-pc-windows-gnullvm<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>17<td><span class="z-source z-nix">
</span><tr><td>18<td><span class="z-source z-nix">      <span class="z-comment z-line z-number-sign z-nix"># Our MacOS targets</span>
</span><tr><td>19<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-apple-darwin<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>20<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-apple-darwin<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>21<td><span class="z-source z-nix">
</span><tr><td>22<td><span class="z-source z-nix">      <span class="z-comment z-line z-number-sign z-nix"># Our Android targets</span>
</span><tr><td>23<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-linux-android<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>24<td><span class="z-source z-nix">      <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-linux-android<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>25<td><span class="z-source z-nix">    <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>26<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>27<td><span class="z-source z-nix">
</span><tr><td>28<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">naersk</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">callPackage</span> <span class="z-variable z-parameter z-name z-nix">inputs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">naersk</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>29<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">cargo</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">toolchain</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>30<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">rustc</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">toolchain</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>31<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>32<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>We now have a latest stable Rust toolchain with all the targets we want to build for.<h2 id=humble-beginnings-cross-compiling-to-linux-targets><a aria-label="Anchor link for: humble-beginnings-cross-compiling-to-linux-targets" class=zola-anchor href=#humble-beginnings-cross-compiling-to-linux-targets>Humble beginnings: cross-compiling to Linux targets</a></h2><p>This is, unsurprisingly, the easiest part.<h3 id=x86-64-linux><a aria-label="Anchor link for: x86-64-linux" class=zola-anchor href=#x86-64-linux>x86_64-linux</a></h3><pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-variable z-parameter z-name z-nix">naersk</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">buildPackage</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">src</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-unquoted z-path z-nix">./.</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>3<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">strictDeps</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">true</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">
</span><tr><td>5<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">nativeBuildInputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>; <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>6<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">llvmPackages</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">bintools</span>
</span><tr><td>7<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>8<td><span class="z-source z-nix">
</span><tr><td>9<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">env</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>10<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_BUILD_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-unknown-linux-musl<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>11<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>-C target-feature=+crt-static -C linker-flavor=ld.lld<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>12<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>13<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>Here we are using the LLVM <code>lld</code> linker instead of GNU <code>ld</code>. We are also telling Rust to link the C runtime statically with the <code>+crt-static</code> flag. Of course Rust doesn't always respect this as you will see in a later section.<aside class=note><p><strong>NOTE</strong><div><p>Using <code>lld</code> is not necessary in our scenario, since we are compiling natively (from <code>x86_64-linux</code> to <code>x86_64-linux</code>). However if you are compiling from a different platform (say, <code>aarch64-linux</code>), then <code>lld</code> is necessary, since GNU <code>ld</code> isn't cross-platform.</div></aside><p>This is enough to compile for <code>x86_64-linux</code>. A <code>nix build</code> will produce a binary, statically linked for you.<h3 id=aarch64-linux><a aria-label="Anchor link for: aarch64-linux" class=zola-anchor href=#aarch64-linux>aarch64-linux</a></h3><p>This is, surprisingly, the same as above, bar a few small changes.<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-variable z-parameter z-name z-nix">naersk</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">buildPackage</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">src</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-unquoted z-path z-nix">./.</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>3<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">strictDeps</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">true</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">
</span><tr><td>5<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">nativeBuildInputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>; <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>6<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">llvmPackages</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">bintools</span>
</span><tr><td>7<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>8<td><span class="z-source z-nix">
</span><tr><td>9<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">env</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>10<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_BUILD_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-unknown-linux-musl<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>11<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_RUSTFLAGS</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>-C target-feature=+crt-static -C linker-flavor=ld.lld<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>12<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>13<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>This is where <code>lld</code> shines. Rust by default uses GNU <code>ld</code> for Linux targets, but since we are cross-compiling and producing binaries for a different CPU architecture, <code>ld</code> will complain about invalid binary format. <code>lld</code> however Just Works:tm:.<h2 id=cross-compiling-to-windows><a aria-label="Anchor link for: cross-compiling-to-windows" class=zola-anchor href=#cross-compiling-to-windows>Cross-compiling to Windows</a></h2><p>This is where the real headache starts.<h3 id=x86-64-windows><a aria-label="Anchor link for: x86-64-windows" class=zola-anchor href=#x86-64-windows>x86_64-windows</a></h3><p>The most popular method to get this to work is:<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-variable z-parameter z-name z-nix">naersk</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">buildPackage</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">src</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-unquoted z-path z-nix">./.</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>3<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">strictDeps</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">true</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">
</span><tr><td>5<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">nativeBuildInputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>; <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>6<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">pkgsCross</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">mingwW64</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">stdenv</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">cc</span>
</span><tr><td>7<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>8<td><span class="z-source z-nix">
</span><tr><td>9<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">buildInputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>; <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>10<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">pkgsCross</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">mingwW64</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">windows</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">pthreads</span>
</span><tr><td>11<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>12<td><span class="z-source z-nix">
</span><tr><td>13<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">env</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>14<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_BUILD_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-pc-windows-gnu<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>15<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>16<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>For this target, Rust defaults to using <code>x86_64-w64-mingw32-gcc</code> as the linker driver. Putting the <code>cc</code> in <code>nativeBuildInputs</code> automatically provides it.<p>However, the above code doesn't actually work. I don't actually know why. When I last tried the exact same thing a few weeks ago it all went fine, but now it just vomits errors about <code>pthreads</code> and undefined symbols. I am, unfortunately, not savvy enough about this problem to fix it.<p>After some serious head-banging, I came up with an idea: what if we use <a href=https://ziglang.org>Zig</a> as the linker instead?<h3 id=a-short-detour-on-zig><a aria-label="Anchor link for: a-short-detour-on-zig" class=zola-anchor href=#a-short-detour-on-zig>A short detour on Zig</a></h3><p>Zig is a programming language which (as of the time of writing) depends on LLVM for its codegen.<p>The kicker about Zig however, is the fact that the Zig binary <a href=https://andrewkelley.me/post/zig-cc-powerful-drop-in-replacement-gcc-clang.html>bundles clang with it</a>. This allows it to compile C/C++ code as well as Zig code.<p>However, the <em><strong>real</strong></em> kicker about Zig is the fact that it <em>bundles libc implementations with it too!</em><p>Normally, the libcs (glibc, musl libc, MinGW, etc.) are shipped to your machine as <em>pre-compiled binaries</em>. These binaries are then linked (dynamically or statically) into your executables. This is a huge problem for cross-compiling (like what we are doing right now). Pre-compiled binaries were... pre-compiled... for one specific target only. We <em>cannot</em> link these pre-compiled binaries into an executable that was compiled for a different target!<p>Zig, instead, had a very funny idea: it bundles the <em>source code</em> of multiple libcs with it, and then <em><strong>compiles them on the fly</strong></em>. This is the reason why Zig has immensely great support for cross-compilation, as well as supporting a myriad number of targets.<p>Using Zig, it is possible to compile the MinGW libc for both <code>x86_64</code> and <code>aarch64</code>, which will enable us to cross-compile Rust for Windows!<h3 id=back-to-cross-compiling><a aria-label="Anchor link for: back-to-cross-compiling" class=zola-anchor href=#back-to-cross-compiling>Back to cross-compiling</a></h3><p>At first, I came up with this derivation:<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-variable z-parameter z-name z-nix">naersk</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">buildPackage</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">src</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-unquoted z-path z-nix">./.</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>3<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">strictDeps</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">true</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">
</span><tr><td>5<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">nativeBuildInputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>; <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>6<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">zig</span>
</span><tr><td>7<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>8<td><span class="z-source z-nix">
</span><tr><td>9<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">env</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>10<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_BUILD_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-pc-windows-gnu<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>11<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">writers</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">writeBash</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>zcc<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-string z-quoted z-other z-nix"><span class="z-punctuation z-definition z-string z-other z-start z-nix">''</span>
</span></span></span></span><tr><td>12<td><span class="z-source z-nix"><span class="z-string z-quoted z-double z-nix"><span class="z-markup z-italic"><span class="z-string z-quoted z-other z-nix">      zig cc -target x86_64-windows-gnu "$@" # Note how Zig takes a different 'target' than Rust
</span></span></span></span><tr><td>13<td><span class="z-source z-nix"><span class="z-string z-quoted z-double z-nix"><span class="z-markup z-italic"><span class="z-string z-quoted z-other z-nix">    <span class="z-punctuation z-definition z-string z-other z-end z-nix">''</span></span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span><span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>14<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>15<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>If you attempt to run this, you will be met with a curious error:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> AccessDenied</span>
</span></code></pre><p>This is a Zig error. Zig attempts to create a cache in your <code>$XDG_CACHE_HOME</code> to store its compilation results. Inside the Nix sandbox, however, this behavior is not allowed. Luckily, we can simply add a hook to make <code>$HOME</code> inside the sandbox writable.<pre class="language-diff z-code" data-lang=diff><code class=language-diff data-lang=diff><span class="z-source z-diff">nativeBuildInputs = with pkgs; [
</span><span class="z-source z-diff">  zig
</span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span> writableTmpDirAsHomeHook
</span></span><span class="z-source z-diff">];
</span></code></pre><p>Now, if you attempt to build again, you will... get more errors! This time it's something about <code>msvcrt</code>:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error:</span></span><span class="z-meta z-function-call z-arguments z-shell"> unable to find dynamic system library <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>msvcrt<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> using strategy <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>no_fallback<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>...<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
</span></code></pre><p>For some ungodly reason, Rust always attempts to insert a <code>-lmsvcrt</code> into the linker commands even if we are <em>not</em> targeting the MSVC ABI.<p>To deal with this, we have to intercept the arguments Rust gives us (the <code>$@</code> in the Bash script) and remove any <code>-lmsvcrt</code> that appears.<p>However, since my Bash skill is (un)fortunately very lacking, I decided to write a Lua script to do it instead.<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">writeLua</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-function z-4 z-nix">filename</span><span class="z-punctuation z-definition z-function z-nix">:</span> <span class="z-variable z-parameter z-function z-4 z-nix">content</span><span class="z-punctuation z-definition z-function z-nix">:</span>
</span><tr><td>3<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">writers</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">makeScriptWriter</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>4<td><span class="z-source z-nix">      <span class="z-comment z-line z-number-sign z-nix"># This is actually just a Bash script that will call Lune (the Lua runtime)</span>
</span><tr><td>5<td><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">interpreter</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">bash</span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span>/bin/bash<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>6<td><span class="z-source z-nix">
</span><tr><td>7<td><span class="z-source z-nix">      <span class="z-comment z-line z-number-sign z-nix"># This adds Lune itself into the PATH of the script</span>
</span><tr><td>8<td><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">makeWrapperArgs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>9<td><span class="z-source z-nix">        <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>--prefix<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>10<td><span class="z-source z-nix">        <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>PATH<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>11<td><span class="z-source z-nix">        <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>:<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>12<td><span class="z-source z-nix">        <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">lib</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">makeBinPath</span> <span class="z-punctuation z-definition z-list z-nix">[</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">lune</span><span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span><span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span>
</span><tr><td>13<td><span class="z-source z-nix">      <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>14<td><span class="z-source z-nix">    <span class="z-punctuation z-definition z-attrset z-nix">}</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>/bin/<span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">filename</span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span><span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-string z-quoted z-other z-nix"><span class="z-punctuation z-definition z-string z-other z-start z-nix">''</span>
</span></span><tr><td>15<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      # This command will invoke Lune, running a script named 'script.luau'
</span></span><tr><td>16<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      # and passing it all the arguments this script was given (which will come from Rust)
</span></span><tr><td>17<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      lune run <span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">writeText</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>script.luau<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-variable z-parameter z-name z-nix">content</span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span> -- "$@"
</span></span><tr><td>18<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    <span class="z-punctuation z-definition z-string z-other z-end z-nix">''</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>19<td><span class="z-source z-nix">
</span><tr><td>20<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">windows-linker</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">writeLua</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>zcc<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-string z-quoted z-other z-nix"><span class="z-punctuation z-definition z-string z-other z-start z-nix">''</span>
</span></span><tr><td>21<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    local process = require("@lune/process")
</span></span><tr><td>22<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    local fs = require("@lune/fs")
</span></span><tr><td>23<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">
</span></span><tr><td>24<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    -- Here we filter out the arguments
</span></span><tr><td>25<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    local filtered_args = {}
</span></span><tr><td>26<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">
</span></span><tr><td>27<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    for _, v in process.args do
</span></span><tr><td>28<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      if v == "-lmsvcrt" then continue end
</span></span><tr><td>29<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">
</span></span><tr><td>30<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      -- Rust also asks for a weirdly named "-l:libpthread.a" which Zig does not understand
</span></span><tr><td>31<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      -- So we change it into "-lpthread" instead
</span></span><tr><td>32<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      if v == "-l:libpthread.a" then
</span></span><tr><td>33<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">        table.insert(filtered_args, "-lpthread")
</span></span><tr><td>34<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">        continue
</span></span><tr><td>35<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      end
</span></span><tr><td>36<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">
</span></span><tr><td>37<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      table.insert(filtered_args, v)
</span></span><tr><td>38<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    end
</span></span><tr><td>39<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">
</span></span><tr><td>40<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    -- Insert the "cc -target $ZIG_TARGET" into the arguments list
</span></span><tr><td>41<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    table.insert(filtered_args, 1, "cc")
</span></span><tr><td>42<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    table.insert(filtered_args, 2, "-target")
</span></span><tr><td>43<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    table.insert(filtered_args, 3, process.env.ZIG_TARGET)
</span></span><tr><td>44<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">
</span></span><tr><td>45<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    -- Spawn a "zig" program with the filtered arguments
</span></span><tr><td>46<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    local result = process.spawn("zig", filtered_args)
</span></span><tr><td>47<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    if not result.ok then
</span></span><tr><td>48<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">      error(result.stdout.. "\n".. result.stderr)
</span></span><tr><td>49<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">    end
</span></span><tr><td>50<td><span class="z-source z-nix"><span class="z-string z-quoted z-other z-nix">  <span class="z-punctuation z-definition z-string z-other z-end z-nix">''</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>51<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><aside class=note><p><strong>NOTE</strong><div><p>If this Lua syntax looks a bit weird to you, it's because it's actually <a href=https://luau.org>Luau</a>! <a href=https://lune-org.github.io/docs>Lune</a> is, in turn, a runtime for Luau, similar to Node.js/Bun for JavaScript and Luvit for Lua.<p>Luau brings some nice additions to Lua (such as that <code>continue</code> statement) and <code>for</code> loops without requiring iterators.</div></aside><p>Now, to use this in our derivation:<pre class="language-diff z-code" data-lang=diff><code class=language-diff data-lang=diff><span class="z-source z-diff">nativeBuildInputs = with pkgs; [
</span><span class="z-source z-diff">  zig
</span><span class="z-source z-diff">  writableTmpDirAsHome
</span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span> windows-linker # We declared the script as 'windows-linker' above
</span></span><span class="z-source z-diff">];
</span></code></pre><pre class="language-diff z-code" data-lang=diff><code class=language-diff data-lang=diff><span class="z-source z-diff">env = {
</span><span class="z-source z-diff">  CARGO_BUILD_TARGET = "x86_64-pc-windows-gnu";
</span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span> CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER = "zcc"; # Our script wrote a wrapper called 'zcc', not 'windows-linker'!
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span> ZIG_TARGET = "x86_64-windows-gnu";
</span></span><span class="z-source z-diff"><span class="z-markup z-deleted z-diff"><span class="z-punctuation z-definition z-deleted z-diff">-</span> CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER = "${pkgs.writers.writeBash "zcc" ''
</span></span><span class="z-source z-diff"><span class="z-markup z-deleted z-diff"><span class="z-punctuation z-definition z-deleted z-diff">-</span>   zig cc -target x86_64-windows-gnu "$@" # Note how Zig takes a different 'target' than Rust
</span></span><span class="z-source z-diff"><span class="z-markup z-deleted z-diff"><span class="z-punctuation z-definition z-deleted z-diff">-</span> ''}";
</span></span><span class="z-source z-diff">};
</span></code></pre><p>Running the build now will see Cargo hanging for a short while, because that's <em>Zig cross-compiling the MinGW libc on the fly!</em><p>Afterwards, it will successfully produce an executable for x86_64 Windows!!<h3 id=aarch64-windows><a aria-label="Anchor link for: aarch64-windows" class=zola-anchor href=#aarch64-windows>aarch64-windows</a></h3><p>If we had gone with the traditional <a href=https://nttis.github.io/blog/cross-compiling-rust/#x86-64-windows>MinGW cross-compiler approach</a>, we would be stuck here, because <code>nixpkgs</code> does not provide an LLVM+MinGW toolchain! There is also no aarch64 MinGW libc (in nixpkgs).<aside class=note><p><strong>NOTE</strong><div><p>This <em><strong>may</strong></em> not be true. While there is no <code>pkgs.pkgsCross.mingwW64-aarch64</code> or anything similar, there is <em><strong>probably</strong></em> a way to compile MinGW for <code>aarch64</code> anyway, through the <code>crossSystem</code> infrastructure in nixpkgs.<p>It is likely that you can do something like:<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">pkgsCross</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-support z-function z-nix">import</span> <span class="z-variable z-parameter z-name z-nix">inputs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">nixpkgs</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>3<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">system</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-linux<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">crossSystem</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-linux<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>5<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>6<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>and then use it like <code>pkgsCross.pkgsCross.mingwW64</code> (probably, I don't know if this is even a real thing).<p>However, this attempts to, um, build the entire world, down to the Linux kernel. So this approach was promptly discarded.</div></aside><p>With Zig as our linker, that is not a problem.<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_BUILD_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-pc-windows-gnullvm<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>3<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_TARGET_AARCH64_PC_WINDOWS_GNULLVM_LINKER</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>zcc<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">ZIG_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>aarch64-windows-gnu<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>5<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>With the power of Zig, we have successfully cross-compiled binaries for Windows from Linux!<h2 id=cross-compiling-to-macos><a aria-label="Anchor link for: cross-compiling-to-macos" class=zola-anchor href=#cross-compiling-to-macos>Cross-compiling to MacOS</a></h2><p>Very surprisingly, MacOS is a breeze to compile to! All it takes is:<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-comment z-line z-number-sign z-nix"># --snip--</span>
</span><tr><td>3<td><span class="z-source z-nix">
</span><tr><td>4<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">nativeBuildInputs</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span>; <span class="z-punctuation z-definition z-list z-nix">[</span>
</span><tr><td>5<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">zig</span>
</span><tr><td>6<td><span class="z-source z-nix">    <span class="z-variable z-parameter z-name z-nix">writableTmpDirAsHomeHook</span>
</span><tr><td>7<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>8<td><span class="z-source z-nix">
</span><tr><td>9<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">env</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>10<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_BUILD_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-apple-darwin<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>11<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">writers</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">writeBash</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>zcc<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-string z-quoted z-other z-nix"><span class="z-punctuation z-definition z-string z-other z-start z-nix">''</span>
</span></span></span></span><tr><td>12<td><span class="z-source z-nix"><span class="z-string z-quoted z-double z-nix"><span class="z-markup z-italic"><span class="z-string z-quoted z-other z-nix">      zig cc -target x86_64-macos "$@"
</span></span></span></span><tr><td>13<td><span class="z-source z-nix"><span class="z-string z-quoted z-double z-nix"><span class="z-markup z-italic"><span class="z-string z-quoted z-other z-nix">    <span class="z-punctuation z-definition z-string z-other z-end z-nix">''</span></span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span><span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>14<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>15<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>We don't have to use the <code>zcc</code>/<code>windows-linker</code> script for this because Rust isn't passing in any unwelcome flags.<p>This will compile for x86_64 Macs. To compile for Apple Silicon, simply replace <code>x86_64</code> with <code>aarch64</code>. It's that simple.<h2 id=cross-compiling-to-android><a aria-label="Anchor link for: cross-compiling-to-android" class=zola-anchor href=#cross-compiling-to-android>Cross-compiling to Android</a></h2><p>Anything involving Android will require the Android SDK/NDK. Luckily for us, nixpkgs does have the Android SDK!<p>Let's set it up:<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">androidPackages</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">androidenv</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">composeAndroidPackages</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>3<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">toolsVersion</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">null</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">buildToolsVersions</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span><span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span> <span class="z-comment z-line z-number-sign z-nix"># We don't need the Android build tools here</span>
</span><tr><td>5<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">includeNDK</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">true</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>6<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>7<td><span class="z-source z-nix">
</span><tr><td>8<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">androidSdk</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">androidPackages</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">androidsdk</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>9<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><aside class=note><p><strong>NOTE</strong><div><p>The Android SDK is <em>non-free</em> software and will require you to accept a license. Nix enforces this by requiring you to declare <code>android_sdk.accept_license = true</code> in your nixpkgs config.</div></aside><p>Then, to compile for <code>x86_64-linux-android</code>:<pre class="language-nix z-code" data-lang=nix data-linenos><code class=language-nix data-lang=nix><table><tbody><tr><td>1<td><span class="z-source z-nix"><span class="z-variable z-parameter z-name z-nix">naersk</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">buildPackage</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>2<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">src</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-unquoted z-path z-nix">./.</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>3<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">strictDeps</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">true</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>4<td><span class="z-source z-nix">
</span><tr><td>5<td><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">env</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><tr><td>6<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_BUILD_TARGET</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>x86_64-linux-android<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>7<td><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">androidSdk</span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span>/libexec/android-sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android35-clang<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><tr><td>8<td><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>  
</span><tr><td>9<td><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></table></code></pre><p>The Android NDK ships with prebuilt binaries of <code>clang</code> for every supported version of Android. We can directly use it as the linker.<p>To compile for <code>aarch64-linux-android</code>, simply substitute the <code>x86_64-linux-android35-clang</code> with <code>aarch64-linux-android35-clang</code> instead!<p>These binaries can then be run on an Android device through Termux or other terminal emulators.<h2 id=what-s-beyond><a aria-label="Anchor link for: what-s-beyond" class=zola-anchor href=#what-s-beyond>What's beyond?</a></h2><p>That was a fun(?) journey. A lot of head-banging/head-scratching/hair-pulling happened. Now, we have reached the end of a long road... or have we?<p>The program we have been attempting to cross-compile is a mere simple "Hello, world!" printer. For any program any more complex than this, things <em>very</em> quickly get out of hands.<p>In fact, I have gone ahead and copy-pasted the entirety of the <a href=https://ratatui.rs/tutorials/counter-app/basic-app/>Ratatui counter app</a> verbatim, ran <code>cargo add ratatui crossterm</code>, and tried to compile for Windows.<p>It broke. I have no idea why. It <em>seems</em> like the <code>winapi</code> crate is doing some funny business, but I cannot say for sure.<p>The Rust ecosystem has a great dependence on the C/C++ ecosystem, often hidden out of sight. Crates like <code>libc</code>, <code>openssl</code>, <code>sqlite</code> all pull in C dependencies. These are... not really feasible to cross-compile, much less for so many vastly different targets we want to support. They are also not really friendly to static linking.<p>Also, I have no idea why, but Rust loves to ignore the <code>+crt-static</code> flag whenever it deems that it cannot statically link. Try to pull in a single C dependency and it is very likely the resulting executable will be dynamically linked instead, despite all your efforts.<p>I have tried to use the <code>openssl</code> crate. Through Nix, I compiled <code>openssl</code> statically and linked against musl libc instead of glibc. This was the entire Rust program:<pre class="language-rust z-code" data-lang=rust data-linenos><code class=language-rust data-lang=rust><table><tbody><tr><td>1<td><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><tr><td>2<td><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">openssl<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">version<span class="z-punctuation z-accessor z-rust">::</span></span>version<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><tr><td>3<td><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></table></code></pre><p>The resulting executable was <em>dynamically linked</em>, despite:<ul><li><code>openssl</code> being statically linked against musl libc<li><code>openssl</code> being set to statically link against the program<li>The <code>+crt-static</code> flag being set<li>The target being <code>x86_64-unknown-linux-musl</code></ul><p>While this was a nice exercise (in futility), any real world, more practical applications should probably just use a container and be done with it. Trying to cross-compile Rust is not a worthy endeavor.<p>I look forward to the day Rust gets cross-compilation support matching that of Zig, however.<hr><footer class=footnotes><ol class=footnotes-list><li id=fn-1><p>The Linux and Windows syscall interfaces are considered stable, so it's possible to statically link on these platforms. MacOS however requires linking against its libSystem in all scenarios since its syscall interface is not stable. Android requires linking against its Bionic libc if you want to use advanced features like networking. <a href=#fr-1-1></a></p></ol></footer></main></article>